<IfModule mod_ssl.c>
SSLStaplingCache shmcb:/var/run/apache2/stapling_cache(128000)
<VirtualHost {% for custom_domain in [mailserver_domain] + custom_domains %}webdav.{{ custom_domain }}:443{% if loop.index != loop.length %} {% endif %}{% endfor %}>
  ServerName webdav.{{ mailserver_domain }}
  ServerAlias {% for custom_domain in custom_domains %}webdav.{{ custom_domain }}{% if loop.index != loop.length %} {% endif %}{% endfor %}

  DocumentRoot /var/www/html/webdav/

  ErrorLog /var/log/httpd/webdav_error.log
  CustomLog /var/log/httpd/webdav_access.log combined

  AddExternalAuth pwauth /usr/bin/pwauth
  SetExternalAuthMethod pwauth pipe

  <IfModule mod_dav_fs.c>
      DAVLockDB /var/lib/dav/lockdb
  </IfModule>
   <Location />
    DAV On
    Options +Indexes
    AuthType Basic
    AuthName "private area"
    AuthBasicProvider external
    AuthExternal pwauth
    Require valid-user
  </Location>

#  <Directory />
#      DAV On
#      SSLRequireSSL
#      Options +Indexes
#      AuthType Basic
#      AuthName "PAM Authentication"
#      AuthBasicProvider external
#      AuthExternal pwauth
#      <RequireAny>
#          Require method GET POST OPTIONS
#          Require valid-user
#      </RequireAny>
#  </Directory>


SSLCertificateFile /etc/letsencrypt/live/{{ mailserver_domain }}/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/{{ mailserver_domain }}/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
Header always set Strict-Transport-Security "max-age=31536000"
SSLUseStapling on
</VirtualHost>
</IfModule>
