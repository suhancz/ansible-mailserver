- name: Configure local DNS cache
  nmcli:
    conn_name: ens192
    ip4: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
    ip6: "{{ hostvars[inventory_hostname]['ansible_default_ipv6']['address'] }}"
    dns4:
      - 127.0.0.1
      - 8.8.8.8
      - 1.1.1.1
    state: present
    type: ethernet
- name: Configure DNSMASQ
  lineinfile:
    path: /etc/dnsmasq.conf
    line: "{{ item }}"
    mode: u=rw,og=r
    owner: root
    group: dnsmasq
    state: present
    backup: yes
  loop:
    - clear-on-reload
    - log-queries
    - dns-loop-detect
    - stop-dns-rebind
    - rebind-localhost-ok
    - domain-needed
    - no-negcache
    - dnssec
    - dnssec-check-unsigned
    - conf-file=/usr/share/dnsmasq/trust-anchors.conf
- name: Make sure DNSMASQ is running
  systemd:
    name: dnsmasq
    daemon_reload: yes
    enabled: yes
    state: restarted
- name: Create resolved.conf.d directory
  file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    owner: root
    group: root
    mode: u=rwX,og=rX
- name: Enable local DNS caching
  blockinfile:
    path: /etc/systemd/resolved.conf.d/LocalDNSCache.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK Local DNS cache"
    block: |
      [Resolve]
      Cache=yes
      # CacheFromLocalhost=yes
      Domains={% for custom_domain in [mailserver_domain] + custom_domains %}{{ custom_domain }} {% if loop.index != loop.length %} {% endif %}{% endfor %}
      DNS=127.0.0.1 8.8.8.8 1.1.1.1
    mode: u=rw,og=r
    owner: root
    group: root
    state: present
    backup: yes
    create: yes
- name: Make sure resolved is running
  systemd:
    name: systemd-resolved
    daemon_reload: yes
    enabled: yes
    state: restarted
